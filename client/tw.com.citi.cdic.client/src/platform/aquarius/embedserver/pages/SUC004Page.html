<?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:wicket="http://wicket.apache.org/">
    <wicket:head>
        <title>Local 檔案維護</title>
    </wicket:head>
    <wicket:extend>
        <div id="localFileList" />
        <p>
            &nbsp;&nbsp;
        </p>
        <a id="exit" class="fg-button ui-state-default ui-corner-all" style="float:none;">離開</a>
        <script type="text/javascript">
            <!--
            var localFileList;
            
            var download = function(row){
                alert('download: ' + row);
                var fileName = localFileList.getCell(row, 'fileName');
                // TODO 下載
            };
            
            var updateStatus = function(actionName, fileName){
                var payload = {};
                payload[AJAX_HANDLER_BUNDLE] = "tw.com.citi.cdic.client";
                payload[AJAX_HANDLER] = "tw.com.citi.cdic.client.handler.SUC004Handler";
                payload.actionName = actionName;
                payload.actionParam = JSON.stringify({
                    "fileName": fileName
                });
                $.ajax({
                    "url": __ajaxHandler,
                    "type": "post",
                    "dataType": "json",
                    "data": payload,
                    "success": function(data){
                        localFileList.addGridData(data);
                        var ids = localFileList.getDataIDs();
                        for (var i = 0; i < ids.length; i++) {
                            var exist = localFileList.getCell(ids[i], "exist");
                            se = "<a class='fg-button ui-state-default ui-corner-all' style='float:none;' onclick='upload(" + ids[i] + ");'>上傳</a>";
                            ce = "<a class='fg-button ui-state-default ui-corner-all' style='float:none;' onclick='confirm(" + ids[i] + ");'>確認</a>";
                            if (exist) {
                                be = "<a class='fg-button ui-state-default ui-corner-all' style='float:none;' onclick='download(" + ids[i] + ");'>下載</a>";
                            }
                            else {
                                be = " ";
                            }
                            localFileList.setRowData(ids[i], {
                                download: be,
                                process: se + ce
                            })
                        }
                    },
                    "error": function(xhr, status, error){
                        var resp = JSON.parse(xhr.responseText);
                        msgDialog.html(resp.message).dialog("open");
                    }
                });
            };
            
            var upload = function(row){
                alert('upload: ' + row);
                var fileName = localFileList.getCell(row, 'fileName');
                //TODO 上傳
                updateStatus('upload', fileName);
            };
            
            var confirm = function(row){
                alert('confirm: ' + row);
                var fileName = localFileList.getCell(row, 'fileName');
                updateStatus('confirm', fileName);
            };
            
            localFileList = $('#localFileList').iGrid({
                datatype: "local",
                height: 400,
                needPager: false,
                sortname: 'name',
                colModel: [{
                    colHeader: 'FileName',
                    name: 'name',
                    sortable: false
                }, {
                    colHeader: ' ',
                    name: 'download',
                    sortable: false
                }, {
                    colHeader: 'Upload DateTime',
                    name: 'uploadDateTime',
                    sortable: false
                }, {
                    colHeader: 'User ID',
                    name: 'processUser',
                    sortable: false
                }, {
                    colHeader: 'Status',
                    name: 'status',
                    sortable: false
                }, {
                    colHeader: 'Process',
                    name: 'process',
                    sortable: false
                }, {
                    name: 'exist',
                    hidden: true
                }]
            });
            $(window).bind('resize', function(){
                localFileList.setGridWidth($(window).width() - 5);
            });
            
            function loadInitInfo(){
                var payload = {};
                payload[AJAX_HANDLER_BUNDLE] = "tw.com.citi.cdic.client";
                payload[AJAX_HANDLER] = "tw.com.citi.cdic.client.handler.SUC004Handler";
                payload.actionName = "getInitInfo";
                $.ajax({
                    "url": __ajaxHandler,
                    "type": "post",
                    "dataType": "json",
                    "data": payload,
                    "success": function(data){
                        localFileList.addGridData(data);
                        var ids = localFileList.getDataIDs();
                        for (var i = 0; i < ids.length; i++) {
                            var exist = localFileList.getCell(ids[i], "exist");
                            se = "<a class='fg-button ui-state-default ui-corner-all' style='float:none;' onclick='upload(" + ids[i] + ");'>上傳</a>";
                            ce = "<a class='fg-button ui-state-default ui-corner-all' style='float:none;' onclick='confirm(" + ids[i] + ");'>確認</a>";
                            if (exist) {
                                be = "<a class='fg-button ui-state-default ui-corner-all' style='float:none;' onclick='download(" + ids[i] + ");'>下載</a>";
                            }
                            else {
                                be = " ";
                            }
                            localFileList.setRowData(ids[i], {
                                download: be,
                                process: se + ce
                            })
                        }
                    },
                    "error": function(xhr, status, error){
                        var resp = JSON.parse(xhr.responseText);
                        msgDialog.html(resp.message).dialog("open");
                    }
                });
            }
            
            loadInitInfo();
            
            $("#exit").click(function(){
                callJava("platform.aquarius.embedserver", "", "platform.aquarius.embedserver.handler.CloseBrowserHandler");
            });
            
            var msgDialog = $("<div></div>").dialog({
                "title": "ERROR",
                "autoOpen": false,
                "modal": true
            });
            -->
        </script>
    </wicket:extend>
</html>
