<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns="http://www.springframework.org/schema/batch" xmlns:beans="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch-2.1.xsd">

    <beans:import resource="database.xml" />

    <beans:import resource="dao.xml" />

    <beans:import resource="batch-decider.xml" />

    <beans:import resource="batch-group1.xml" />

    <beans:import resource="SBF01.xml" />

    <beans:import resource="SBF02.xml" />

    <beans:import resource="SBF03.xml" />

    <beans:import resource="SBF04.xml" />

    <beans:import resource="SBF05.xml" />

    <beans:import resource="SBF07.xml" />

    <beans:import resource="SBF08.xml" />

    <beans:import resource="SBF10.xml" />

    <beans:import resource="SBF11.xml" />

    <beans:import resource="SBF12.xml" />

    <beans:import resource="SBF14.xml" />

    <beans:import resource="SBF15.xml" />

    <beans:import resource="SBF18.xml" />

    <beans:import resource="SBF21.xml" />

    <beans:import resource="SBF22.xml" />

    <beans:import resource="SBF24.xml" />

    <beans:import resource="SBF25.xml" />

    <beans:import resource="SBT02.xml" />

    <beans:import resource="SBT03.xml" />

    <beans:import resource="SBT04.xml" />

    <beans:import resource="SBT06.xml" />

    <beans:import resource="SBT08.xml" />

    <beans:import resource="SBT09.xml" />

    <beans:import resource="SBT10.xml" />

    <beans:import resource="SBT11.xml" />

    <beans:import resource="SBT13.xml" />

    <beans:import resource="SBT14.xml" />

    <beans:import resource="SBT18.xml" />

    <beans:import resource="SBT20.xml" />

    <beans:import resource="SBT21.xml" />

    <beans:import resource="SBT27.xml" />

    <job-repository />

    <beans:bean id="asyncTaskExecutor" class="org.springframework.core.task.SimpleAsyncTaskExecutor"></beans:bean>

    <beans:bean id="jobLauncher" class="org.springframework.batch.core.launch.support.SimpleJobLauncher">
        <beans:property name="jobRepository" ref="jobRepository" />
        <beans:property name="taskExecutor" ref="asyncTaskExecutor" />
    </beans:bean>

    <beans:bean id="itemSqlParameterSourceProvider" class="org.springframework.batch.item.database.BeanPropertyItemSqlParameterSourceProvider"></beans:bean>

    <job id="copyViewJob">
        <split id="copyView" next="updateTableFlowInitStatus" task-executor="asyncTaskExecutor">
            <flow>
                <step id="deleteLocalBus" next="copyBusView">
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource"></beans:property>
                            <beans:property name="sql" value="DELETE FROM LOCAL_BUS"></beans:property>
                        </beans:bean>
                    </tasklet>
                </step>
                <step id="copyBusView">
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource"></beans:property>
                            <beans:property name="sql"
                                value="INSERT INTO LOCAL_BUS (CUST_NUMB, CUST_TYPE, NATNID_REGNNUMB, CUST_TITL_LINE1, DSCT_DESC_L, BIRTHDAY, BRANCH, DATE_ESTB, CUST_STAT, BIZ_TYPE, CUST_ASSNNATID, CUST_ASSNNAME) SELECT CUST_NUMB, CUST_TYPE, NATNID_REGNNUMB, CUST_TITL_LINE1, DSCT_DESC_L, BIRTHDAY, BRANCH, DATE_ESTB, CUST_STAT, BIZ_TYPE, CUST_ASSNNATID, CUST_ASSNNAME FROM BUS"></beans:property>
                        </beans:bean>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <step id="deleteLocalLus" next="copyLusView">
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource"></beans:property>
                            <beans:property name="sql" value="DELETE FROM LOCAL_LUS"></beans:property>
                        </beans:bean>
                    </tasklet>
                </step>
                <step id="copyLusView">
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource"></beans:property>
                            <beans:property name="sql"
                                value="INSERT INTO LOCAL_LUS (ACCT_NO, UNINO, PROD_NAME, BALANCE, INTEREST, STATUS, NAME, NEW_B_CODE, PERSON_TYPE, COMPANY, COMM_ADR) SELECT ACCT_NO, UNINO, PROD_NAME, BALANCE, INTEREST, STATUS, NAME, NEW_B_CODE, PERSON_TYPE, COMPANY, COMM_ADR FROM LUS"></beans:property>
                        </beans:bean>
                    </tasklet>
                </step>
            </flow>
        </split>
        <step id="updateTableFlowInitStatus">
            <tasklet>
                <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                    <beans:property name="dataSource" ref="dataSource"></beans:property>
                    <beans:property name="sql" value="UPDATE TABLEFLOW SET INITSTATUS = '2'"></beans:property>
                </beans:bean>
            </tasklet>
        </step>
    </job>

    <job id="convertJob">
        <split id="importFiles" next="import-f07-f18" task-executor="asyncTaskExecutor">
            <flow>
                <decision id="f01Decision" decider="f01Decider">
                    <next on="EXECUTE" to="f01-del" />
                    <end on="SKIP" />
                </decision>
                <step id="f01-del" next="f01-db">
                    <description>把 A11 table 的資料清空</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource" />
                            <beans:property name="sql" value="DELETE FROM A11" />
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f01-db" next="f01-del-joint-account">
                    <description>把 bus view 的資料 export 至 A11 table</description>
                    <tasklet>
                        <chunk reader="busDbReader" processor="f01Processor" writer="a11DbWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f01-del-joint-account" next="f01-copy-joint-account">
                    <description>把 Joint Account table 的資料清空</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource" />
                            <beans:property name="sql" value="DELETE FROM JOINT_ACCOUNT" />
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f01-copy-joint-account" next="f01-del-cif">
                    <description>把 Joint Account 檔案的資料寫入 table 中</description>
                    <tasklet>
                        <chunk reader="jointAcclistFileReader" writer="jointAccountDbWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f01-del-cif" next="f01-gen-cif">
                    <description>把 Joint Account table 的資料清空</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource" />
                            <beans:property name="sql" value="DELETE FROM CIF" />
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f01-gen-cif" next="f01-update-a11">
                    <description>產生 CIF table 的資料</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource" />
                            <beans:property name="sql">
                                <beans:value>
                                    <![CDATA[
                                        INSERT INTO CIF(NATNID_REGNNUMB, CUST_NUMB, CIF, JOINT_FLAG, JOINT_ID)
                                        SELECT
                                            T1.*,
                                            CASE(T1.JOINT_FLAG)
                                                WHEN 'Y' THEN ISNULL(MIN(T2.CIF), T1.NATNID_REGNNUMB)
                                                ELSE T1.CIF
                                            END AS JOINT_ID
                                        FROM (
                                            SELECT
                                                NATNID_REGNNUMB,
                                                CUST_NUMB,
                                                CASE(RANK() OVER(PARTITION BY NATNID_REGNNUMB ORDER BY M DESC, CUST_NUMB) - 1)
                                                    WHEN 0 THEN NATNID_REGNNUMB
                                                    ELSE RTRIM(NATNID_REGNNUMB) + (CONVERT(VARCHAR(3), RANK() OVER(PARTITION BY NATNID_REGNNUMB ORDER BY M DESC, CUST_NUMB) - 1))
                                                END AS CIF,
                                                CASE(M)
                                                    WHEN 'N' THEN 'N'
                                                    ELSE 'Y'
                                                END AS JOINT_FLAG
                                            FROM (
                                                SELECT LB.NATNID_REGNNUMB, LB.CUST_NUMB, ISNULL(JA.CUST_NUMB, 'N') AS M
                                                FROM LOCAL_BUS LB
                                                LEFT JOIN (SELECT DISTINCT CUST_NUMB FROM JOINT_ACCOUNT) JA ON LB.CUST_NUMB = JA.CUST_NUMB
                                            ) T
                                        ) T1
                                        LEFT JOIN (
                                            SELECT
                                                NATNID_REGNNUMB,
                                                CUST_NUMB,
                                                CASE(RANK() OVER(PARTITION BY NATNID_REGNNUMB ORDER BY M DESC, CUST_NUMB) - 1)
                                                    WHEN 0 THEN NATNID_REGNNUMB
                                                    ELSE RTRIM(NATNID_REGNNUMB) + (CONVERT(VARCHAR(3), RANK() OVER(PARTITION BY NATNID_REGNNUMB ORDER BY M DESC, CUST_NUMB) - 1))
                                                END AS CIF,
                                                CASE(M)
                                                    WHEN 'N' THEN 'N'
                                                    ELSE 'Y'
                                                END AS JOINT_FLAG
                                            FROM (
                                                SELECT LB.NATNID_REGNNUMB, LB.CUST_NUMB, ISNULL(JA.CUST_NUMB, 'N') AS M
                                                FROM LOCAL_BUS LB
                                                LEFT JOIN (SELECT DISTINCT CUST_NUMB FROM JOINT_ACCOUNT) JA ON LB.CUST_NUMB = JA.CUST_NUMB
                                            ) T
                                        ) T2 ON T2.JOINT_FLAG = 'N' AND T1.NATNID_REGNNUMB = T2.NATNID_REGNNUMB
                                        GROUP BY T1.NATNID_REGNNUMB, T1.CIF, T1.CUST_NUMB, T1.JOINT_FLAG
                                    ]]>
                                </beans:value>
                            </beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f01-update-a11" next="f01-copy-non-joint-data">
                    <description>把 A11 table 的 natnid_regnnumb 欄位資料更新 CIF table 裏的 joint_id 欄位值</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource" />
                            <beans:property name="sql" value="UPDATE A11 SET CUSTHEADID = (SELECT SUBSTRING(CIF.JOINT_ID, 1, 11) FROM CIF WHERE A11.CUSTID = CIF.CUST_NUMB) WHERE EXISTS (SELECT CIF.JOINT_ID FROM CIF WHERE A11.CUSTID = CIF.CUST_NUMB)" />
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f01-copy-non-joint-data" next="f01-file">
                    <description>把 CIF table 中的資料新增至 A11 table</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource" />
                            <beans:property name="sql">
                                <beans:value>
                                    <![CDATA[
                                        INSERT INTO A11 (CUSTUNIT, CUSTBRNO, CUSTID, CUSTIDNO, CUSTHEADID, CUSTCNAME, CUSTBIRDATE, CUSTCEOCODE, CUSTCEONAME, CUSTSTACODE, CUSTBUSCODE, CUSTCRTDATE, CUSTOADDRESS, CUSTADDRESS, CUSTTEL1, CUSTTEL2, CUSTEMAILADD)
                                        SELECT
                                            '021' CUSTUNIT,
                                            '0000' CUSTBRNO,
                                            CIF.JOINT_ID CUSTID,
                                            '' CUSTIDNO,
                                            CIF.JOINT_ID CUSTHEADID,
                                            LB.CUST_TITL_LINE1 CUSTCNAME,
                                            LB.BIRTHDAY CUSTBIRDATE,
                                            LB.CUST_ASSNNATID CUSTCEOCODE,
                                            LB.CUST_ASSNNAME CUSTCEONAME,
                                            LB.CUST_STAT CUSTSTACODE,
                                            LB.BIZ_TYPE CUSTBUSCODE,
                                            LB.DATE_ESTB CUSTCRTDATE,
                                            '' CUSTOADDRESS,
                                            LTRIM(RTRIM(SUBSTRING(LB.DSCT_DESC_L, 1, 6))) CUSTADDRESS,
                                            '' CUSTTEL1,
                                            '' CUSTTEL2,
                                            '' CUSTEMAILADD
                                        FROM CIF
                                        LEFT JOIN LOCAL_BUS LB ON CIF.CUST_NUMB = LB.CUST_NUMB
                                        WHERE CIF.CUST_NUMB = CIF.JOINT_ID;
                                    ]]>
                                </beans:value>
                            </beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f01-file">
                    <description>把 A11 table 的資料 copy 至 A11 file</description>
                    <tasklet>
                        <chunk reader="a11DbReader" processor="f01SampleCountProcessor" writer="a11Writer" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <step id="group1Step">
                    <job ref="group1Job" />
                </step>
            </flow>
            <flow>
                <decision id="f05Decision" decider="f05Decider">
                    <next on="EXECUTE" to="f05-init" />
                    <end on="SKIP" />
                </decision>
                <step id="f05-init" next="f05">
                    <description>刪除 table A24 的所有資料</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource"></beans:property>
                            <beans:property name="sql" value="DELETE FROM A24"></beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f05">
                    <description>讀取 LUS view 的資料，然後產生 A24 table 及 file。</description>
                    <tasklet>
                        <chunk reader="lusDbReader" processor="f05Processor" writer="a24Writer" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="f10Decision" decider="f10Decider">
                    <next on="EXECUTE" to="f10-sample" />
                    <end on="SKIP" />
                </decision>
                <step id="f10-sample" next="f10-copy">
                    <description>產生 f10 sample file</description>
                    <tasklet>
                        <chunk reader="cdicF10FileReader" processor="f10SampleProcessor" writer="a34SampleFileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f10-copy" next="f10db-init">
                    <description>把 host file CDICF10 的資料複製至 A34 file</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.CopyFilesTasklet">
                            <beans:property name="sourceDir" value="#{systemProperties['FOLDER.PROCESS']}/CDICF10"></beans:property>
                            <beans:property name="targetDir" value="#{systemProperties['FOLDER.PROCESS.OUT']}/A34"></beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f10db-init" next="f10-a34db">
                    <description>刪除 table A34 的所有資料</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource"></beans:property>
                            <beans:property name="sql" value="DELETE FROM A34"></beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f10-a34db">
                    <description>CDICF10 寫入 A34</description>
                    <tasklet>
                        <chunk reader="cdicF10FileReader" writer="a34DbWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="f11Decision" decider="f11Decider">
                    <next on="EXECUTE" to="f11" />
                    <end on="SKIP" />
                </decision>
                <step id="f11">
                    <description>把 local file CDICF11 資料寫至 A35 file</description>
                    <tasklet>
                        <chunk reader="cdicF11FileReader" processor="SBF11Processor" writer="f11Writer" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="f12Decision" decider="f12Decider">
                    <next on="EXECUTE" to="f12-sample" />
                    <end on="SKIP" />
                </decision>
                <step id="f12-sample" next="f12-copy">
                    <description>產生 f12 sample file</description>
                    <tasklet>
                        <chunk reader="cdicF12FileReader" processor="f12SampleProcessor" writer="a41SampleFileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f12-copy" next="f12db-init">
                    <description>把 host file CDICF12 的資料複製至 A41 file</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.CopyFilesTasklet">
                            <beans:property name="sourceDir" value="#{systemProperties['FOLDER.PROCESS']}/CDICF12"></beans:property>
                            <beans:property name="targetDir" value="#{systemProperties['FOLDER.PROCESS.OUT']}/A41"></beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f12db-init" next="f12-a41db">
                    <description>刪除 table A41 的所有資料</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource"></beans:property>
                            <beans:property name="sql" value="DELETE FROM A41"></beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f12-a41db">
                    <description>CDICF12 寫入 A41</description>
                    <tasklet>
                        <chunk reader="cdicF12FileReader" writer="a41DbWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="f14Decision" decider="f14Decider">
                    <next on="EXECUTE" to="f14-sample" />
                    <end on="SKIP" />
                </decision>
                <step id="f14-sample" next="f14-copy">
                    <description>產生 f14 sample file</description>
                    <tasklet>
                        <chunk reader="cdicF14FileReader" processor="f14SampleProcessor" writer="a43SampleFileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f14-copy">
                    <description>把 host file CDICF14 的資料複製至 A43 file</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.CopyFilesTasklet">
                            <beans:property name="sourceDir" value="#{systemProperties['FOLDER.PROCESS']}/CDICF14"></beans:property>
                            <beans:property name="targetDir" value="#{systemProperties['FOLDER.PROCESS.OUT']}/A43"></beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="f15Decision" decider="f15Decider">
                    <next on="EXECUTE" to="f15-sample" />
                    <end on="SKIP" />
                </decision>
                <step id="f15-sample" next="f15-copy">
                    <description>產生 f15 sample file</description>
                    <tasklet>
                        <chunk reader="cdicF15FileReader" processor="f15SampleProcessor" writer="a44SampleFileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f15-copy">
                    <description>把 host file CDICF15 的資料複製至 A44 file</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.CopyFilesTasklet">
                            <beans:property name="sourceDir" value="#{systemProperties['FOLDER.PROCESS']}/CDICF15"></beans:property>
                            <beans:property name="targetDir" value="#{systemProperties['FOLDER.PROCESS.OUT']}/A44"></beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="f21Decision" decider="f21Decider">
                    <next on="EXECUTE" to="f21-a73db-init" />
                    <end on="SKIP" />
                </decision>
                <step id="f21-a73db-init" next="f21i-a73db">
                    <description>刪除 table A73 的所有資料</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource"></beans:property>
                            <beans:property name="sql" value="DELETE FROM A73"></beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f21i-a73db" next="f21r">
                    <description>把 host file CDICF21I 的資料寫入 A73 table</description>
                    <tasklet>
                        <chunk reader="cdicF21IFileReader" writer="a73DbWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f21r" next="f21-a73db-a73file">
                    <description>把 host file CDICF21R 的資料寫入 A73 table, B73 file, C73 file</description>
                    <tasklet>
                        <chunk reader="cdicF21RFileReader" processor="f21Processor" writer="f21Writer1" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f21-a73db-a73file">
                    <description>把  A73 table 的資料寫入  A73 file, C73 file</description>
                    <tasklet>
                        <chunk reader="a73DbReader" processor="f21a73Processor" writer="f21Writer2" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="f22Decision" decider="f22Decider">
                    <next on="EXECUTE" to="f22db-init" />
                    <end on="SKIP" />
                </decision>
                <step id="f22db-init" next="f22i-a74db">
                    <description>刪除 table A74 的所有資料</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource"></beans:property>
                            <beans:property name="sql" value="DELETE FROM A74"></beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f22i-a74db" next="f22a-a74db">
                    <description>CDIC22I 寫入 A74</description>
                    <tasklet>
                        <chunk reader="cdicF22IFileReader" writer="a74DbWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f22a-a74db" next="f22r-a74db">
                    <description>CDIC22A 寫入 A74</description>
                    <tasklet>
                        <chunk reader="cdicF22AFileReader" writer="a74DbWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f22r-a74db" next="f22">
                    <description>CDIC22R 寫入 A74</description>
                    <tasklet>
                        <chunk reader="cdicF22RFileReader" processor="f22dbProcessor" writer="a74ListDbWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f22">
                    <description>把 A74 db 資料寫至 A74 file</description>
                    <tasklet>
                        <chunk reader="a74DbReader" processor="f22Processor" writer="f22Writer" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="f24Decision" decider="f24Decider">
                    <next on="EXECUTE" to="f24-sample" />
                    <end on="SKIP" />
                </decision>
                <step id="f24-sample" next="f24-copy">
                    <description>產生 f24 sample file</description>
                    <tasklet>
                        <chunk reader="cdicF24FileReader" processor="f24SampleProcessor" writer="a76SampleFileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f24-copy" next="f24db-init">
                    <description>把 host file CDICF24 的資料複製至 A76 file</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.CopyFilesTasklet">
                            <beans:property name="sourceDir" value="#{systemProperties['FOLDER.PROCESS']}/CDICF24"></beans:property>
                            <beans:property name="targetDir" value="#{systemProperties['FOLDER.PROCESS.OUT']}/A76"></beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f24db-init" next="f24-a76db">
                    <description>刪除 table A76 的所有資料</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource"></beans:property>
                            <beans:property name="sql" value="DELETE FROM A76"></beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f24-a76db">
                    <description>CDICF24 寫入 A76</description>
                    <tasklet>
                        <chunk reader="cdicF24FileReader" writer="a76DbWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="f25Decision" decider="f25Decider">
                    <next on="EXECUTE" to="f25-sample" />
                    <end on="SKIP" />
                </decision>
                <step id="f25-sample" next="f25-copy">
                    <description>產生 f25 sample file</description>
                    <tasklet>
                        <chunk reader="cdicF25FileReader" processor="f25SampleProcessor" writer="a77SampleFileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f25-copy">
                    <description>把 host file CDICF25 的資料複製至 A77 file</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.CopyFilesTasklet">
                            <beans:property name="sourceDir" value="#{systemProperties['FOLDER.PROCESS']}/CDICF25"></beans:property>
                            <beans:property name="targetDir" value="#{systemProperties['FOLDER.PROCESS.OUT']}/A77"></beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="t02Decision" decider="t02Decider">
                    <next on="EXECUTE" to="t02A-init" />
                    <end on="SKIP" />
                </decision>
                <step id="t02A-init" next="t02-table">
                    <description>刪除 table t02 的所有資料</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource"></beans:property>
                            <beans:property name="sql" value="DELETE FROM T02"></beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="t02-table" next="t02-t02">
                    <description>把 FMBCDWN4 的資料 insert 至 T02 table</description>
                    <tasklet>
                        <chunk reader="fmbcdwn4FileReader" processor="t02Processor" writer="t02DbWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="t02-t02">
                    <description>把 T02 Table 的資料 import 至 T02 file</description>
                    <tasklet>
                        <chunk reader="t02DbReader" writer="t02FileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="t03Decision" decider="t03Decider">
                    <next on="EXECUTE" to="t03-t03" />
                    <end on="SKIP" />
                </decision>
                <step id="t03-t03" next="t12">
                    <description>把 CDICT03G 的資料 import 至 T03 file</description>
                    <tasklet>
                        <chunk reader="cdicT03GFileReader" processor="t03Processor" writer="t03FileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="t12">
                    <description>把 CDICT03G 的資料 import 至 T12 file</description>
                    <tasklet>
                        <chunk reader="cdicT03GFileReader" processor="t12Processor" writer="t12FileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="t06Decision" decider="t06Decider">
                    <next on="EXECUTE" to="t06A-init" />
                    <end on="SKIP" />
                </decision>
                <step id="t06A-init" next="t06">
                    <description>刪除 table t06 的所有資料</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource"></beans:property>
                            <beans:property name="sql" value="DELETE FROM T06"></beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="t06" next="t06-t03">
                    <description>把 CDICT06 的資料 import 至 T06 file</description>
                    <tasklet>
                        <chunk reader="cdicT06FileReader" processor="t06Processor" writer="t06DbWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="t06-t03" next="t06-file">
                    <description>把 CDICT03G 的資料 import 至 T06 file</description>
                    <tasklet>
                        <chunk reader="cdicT03GFileReader" processor="t03t06Processor" writer="t06DbWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="t06-file">
                    <description>把 CDICT03G 的資料 import 至 T06 file</description>
                    <tasklet>
                        <chunk reader="t06DbReader" writer="t06FileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="t04Decision" decider="t04Decider">
                    <next on="EXECUTE" to="t04" />
                    <end on="SKIP" />
                </decision>
                <step id="t04">
                    <description>把 local file CDICT04 資料寫至 T04 file</description>
                    <tasklet>
                        <chunk reader="cdicT04FileReader" writer="t04FileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="t08Decision" decider="t08Decider">
                    <next on="EXECUTE" to="t08" />
                    <end on="SKIP" />
                </decision>
                <step id="t08">
                    <description>把 local file CDICT08 資料寫至 T08 file</description>
                    <tasklet>
                        <chunk reader="cdicT08FileReader" writer="t08FileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="t09Decision" decider="t09Decider">
                    <next on="EXECUTE" to="t09" />
                    <end on="SKIP" />
                </decision>
                <step id="t09">
                    <description>把 local file CDICT09 資料寫至 T09 file</description>
                    <tasklet>
                        <chunk reader="cdicT09FileReader" writer="t09FileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="t10Decision" decider="t10Decider">
                    <next on="EXECUTE" to="t10" />
                    <end on="SKIP" />
                </decision>
                <step id="t10">
                    <description>把 local file CDICT10 資料寫至 T10 file</description>
                    <tasklet>
                        <chunk reader="cdicT10FileReader" writer="t10FileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="t11Decision" decider="t11Decider">
                    <next on="EXECUTE" to="t11" />
                    <end on="SKIP" />
                </decision>
                <step id="t11">
                    <description>把 local file CDICT11 資料寫至 T11 file</description>
                    <tasklet>
                        <chunk reader="cdicT11FileReader" writer="t11FileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="t13Decision" decider="t13Decider">
                    <next on="EXECUTE" to="t13" />
                    <end on="SKIP" />
                </decision>
                <step id="t13">
                    <description>把 local file CDICT13 資料寫至 T13 file</description>
                    <tasklet>
                        <chunk reader="cdicT13FileReader" writer="t13FileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="t14Decision" decider="t14Decider">
                    <next on="EXECUTE" to="t14" />
                    <end on="SKIP" />
                </decision>
                <step id="t14">
                    <description>把 local file CDICT14 資料寫至 T14 file</description>
                    <tasklet>
                        <chunk reader="cdicT14FileReader" writer="t14FileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="t18Decision" decider="t18Decider">
                    <next on="EXECUTE" to="t18" />
                    <end on="SKIP" />
                </decision>
                <step id="t18">
                    <description>把 local file CDICT18 資料寫至 T18 file</description>
                    <tasklet>
                        <chunk reader="cdicT18FileReader" writer="t18FileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="t20Decision" decider="t20Decider">
                    <next on="EXECUTE" to="t20" />
                    <end on="SKIP" />
                </decision>
                <step id="t20">
                    <description>把 local file CDICT20 資料寫至 T20 file</description>
                    <tasklet>
                        <chunk reader="cdicT20FileReader" writer="t20FileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="t21Decision" decider="t21Decider">
                    <next on="EXECUTE" to="t21" />
                    <end on="SKIP" />
                </decision>
                <step id="t21">
                    <description>把 local file CDICT21 資料寫至 T21 file</description>
                    <tasklet>
                        <chunk reader="cdicT21FileReader" writer="t21FileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="t27Decision" decider="t27Decider">
                    <next on="EXECUTE" to="t27" />
                    <end on="SKIP" />
                </decision>
                <step id="t27">
                    <description>把 CDICT27H 的資料 import 至 T27 file</description>
                    <tasklet>
                        <chunk reader="cdicT27FileReader" processor="t27Processor" writer="t27FileWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
        </split>
        <split id="import-f07-f18" task-executor="asyncTaskExecutor">
            <flow>
                <decision id="f07Decision" decider="f07Decider">
                    <next on="EXECUTE" to="f07-init" />
                    <next on="SKIP" to="f99Decision" />
                </decision>
                <step id="f07-init" next="f07-split">
                    <description>清空 table A26, B26, C26, A26_FO, B26_FO, C26_FO 的資料</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource" />
                            <beans:property name="sql" value="DELETE FROM A26; DELETE FROM B26; DELETE FROM C26; DELETE FROM A26_FO; DELETE FROM B26_FO; DELETE FROM C26_FO;" />
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f07-split" next="f07-insert-del1">
                    <description>把 CDICF07H 的資料分檔並套上客戶資料，然後 copy 至 A26, B26, C26 table</description>
                    <tasklet>
                        <chunk reader="cdicF07FileReader" processor="f07Processor" writer="f07DbWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f07-insert-del1" next="f07-delete">
                    <description>把同一群組中有兩筆以上大於或等於零的資料記錄至 table 中</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource" />
                            <beans:property name="sql">
                                <beans:value>
                                    <![CDATA[
                                        INSERT INTO A26_FO (OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO)
                                        SELECT OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO
                                        FROM (
                                            SELECT OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO, COUNT(*) C
                                            FROM A26
                                            WHERE OTPAYSAV >= 0
                                            GROUP BY OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO
                                        ) T
                                        WHERE T.C > 1;
                                        
                                        INSERT INTO B26_FO (OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO)
                                        SELECT OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO
                                        FROM (
                                            SELECT OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO, COUNT(*) C
                                            FROM B26
                                            WHERE OTPAYSAV >= 0
                                            GROUP BY OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO
                                        ) T
                                        WHERE T.C > 1;
                                        
                                        INSERT INTO C26_FO (OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO)
                                        SELECT OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO
                                        FROM (
                                            SELECT OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO, COUNT(*) C
                                            FROM C26
                                            WHERE OTPAYSAV >= 0
                                            GROUP BY OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO
                                        ) T
                                        WHERE T.C > 1;
                                    ]]>
                                </beans:value>
                            </beans:property>
                        </beans:bean>
                    </tasklet>
                </step>
                <step id="f07-delete" next="f07-insert-del2">
                    <description>若同一群組當中，有兩筆以上金額大於零的資料，就把整個群組資料刪掉</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource" />
                            <beans:property name="sql">
                                <beans:value>
                                    <![CDATA[
                                        DELETE FROM A26 WHERE EXISTS (
                                            SELECT *
                                            FROM (
                                                SELECT *
                                                FROM (
                                                    SELECT OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO, COUNT(*) C
                                                    FROM A26
                                                    WHERE OTPAYSAV >= 0
                                                    GROUP BY OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO
                                                ) T
                                                WHERE T.C > 1
                                            ) T2
                                            WHERE A26.OTAPNO = T2.OTAPNO
                                                AND A26.OTCOMPCODE = T2.OTCOMPCODE
                                                AND A26.OTRCCODE = T2.OTRCCODE
                                                AND A26.OTREFNO = T2.OTREFNO
                                        );
                                        
                                        DELETE FROM B26 WHERE EXISTS (
                                            SELECT *
                                            FROM (
                                                SELECT *
                                                FROM (
                                                    SELECT OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO, COUNT(*) C
                                                    FROM B26
                                                    WHERE OTPAYSAV >= 0
                                                    GROUP BY OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO
                                                ) T
                                                WHERE T.C > 1
                                            ) T2
                                            WHERE B26.OTAPNO = T2.OTAPNO
                                                AND B26.OTCOMPCODE = T2.OTCOMPCODE
                                                AND B26.OTRCCODE = T2.OTRCCODE
                                                AND B26.OTREFNO = T2.OTREFNO
                                        );
                                        
                                        DELETE FROM C26 WHERE EXISTS (
                                            SELECT *
                                            FROM (
                                                SELECT *
                                                FROM (
                                                    SELECT OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO, COUNT(*) C
                                                    FROM C26
                                                    WHERE OTPAYSAV >= 0
                                                    GROUP BY OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO
                                                ) T
                                                WHERE T.C > 1
                                            ) T2
                                            WHERE C26.OTAPNO = T2.OTAPNO
                                                AND C26.OTCOMPCODE = T2.OTCOMPCODE
                                                AND C26.OTRCCODE = T2.OTRCCODE
                                                AND C26.OTREFNO = T2.OTREFNO
                                        );
                                    ]]>
                                </beans:value>
                            </beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f07-insert-del2" next="f07-sum">
                    <description>把加總後金額小於或等於零的資料記錄到 table 中</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource" />
                            <beans:property name="sql">
                                <beans:value>
                                    <![CDATA[
                                        INSERT INTO A26_FO (OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO)
                                        SELECT OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO
                                        FROM A26
                                        GROUP BY OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO
                                        HAVING SUM(OTPAYSAV) &lt;= 0;
                                        
                                        INSERT INTO B26_FO (OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO)
                                        SELECT OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO
                                        FROM B26
                                        GROUP BY OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO
                                        HAVING SUM(OTPAYSAV) &lt;= 0;
                                        
                                        INSERT INTO C26_FO (OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO)
                                        SELECT OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO
                                        FROM C26
                                        GROUP BY OTAPNO, OTCOMPCODE, OTRCCODE, OTREFNO
                                        HAVING SUM(OTPAYSAV) &lt;= 0;
                                    ]]>
                                </beans:value>
                            </beans:property>
                        </beans:bean>
                    </tasklet>
                </step>
                <step id="f07-sum" next="f07-del-neg">
                    <description>加總金額欄位</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource" />
                            <beans:property name="sql">
                                <beans:value>
                                    <![CDATA[
                                        UPDATE A26 SET OTPAYSAV = (
                                            SELECT SUM(OTPAYSAV)
                                            FROM A26 B
                                            WHERE A26.OTAPNO = B.OTAPNO
                                                AND A26.OTCOMPCODE = B.OTCOMPCODE
                                                AND A26.OTRCCODE = B.OTRCCODE
                                                AND A26.OTREFNO = B.OTREFNO
                                            GROUP BY B.OTAPNO, B.OTCOMPCODE, B.OTRCCODE, B.OTREFNO
                                        )
                                        WHERE EXISTS (
                                            SELECT *
                                            FROM A26 B
                                            WHERE A26.OTAPNO = B.OTAPNO
                                                AND A26.OTCOMPCODE = B.OTCOMPCODE
                                                AND A26.OTRCCODE = B.OTRCCODE
                                                AND A26.OTREFNO = B.OTREFNO
                                                AND A26.OTPAYSAV >= 0
                                        );
                                        
                                        UPDATE B26 SET OTPAYSAV = (
                                            SELECT SUM(OTPAYSAV)
                                            FROM B26 B
                                            WHERE B26.OTAPNO = B.OTAPNO
                                                AND B26.OTCOMPCODE = B.OTCOMPCODE
                                                AND B26.OTRCCODE = B.OTRCCODE
                                                AND B26.OTREFNO = B.OTREFNO
                                            GROUP BY B.OTAPNO, B.OTCOMPCODE, B.OTRCCODE, B.OTREFNO
                                        )
                                        WHERE EXISTS (
                                            SELECT *
                                            FROM B26 B
                                            WHERE B26.OTAPNO = B.OTAPNO
                                                AND B26.OTCOMPCODE = B.OTCOMPCODE
                                                AND B26.OTRCCODE = B.OTRCCODE
                                                AND B26.OTREFNO = B.OTREFNO
                                                AND B26.OTPAYSAV >= 0
                                        );
                                        
                                        UPDATE C26 SET OTPAYSAV = (
                                            SELECT SUM(OTPAYSAV)
                                            FROM C26 B
                                            WHERE C26.OTAPNO = B.OTAPNO
                                                AND C26.OTCOMPCODE = B.OTCOMPCODE
                                                AND C26.OTRCCODE = B.OTRCCODE
                                                AND C26.OTREFNO = B.OTREFNO
                                            GROUP BY B.OTAPNO, B.OTCOMPCODE, B.OTRCCODE, B.OTREFNO
                                        )
                                        WHERE EXISTS (
                                            SELECT *
                                            FROM C26 B
                                            WHERE C26.OTAPNO = B.OTAPNO
                                                AND C26.OTCOMPCODE = B.OTCOMPCODE
                                                AND C26.OTRCCODE = B.OTRCCODE
                                                AND C26.OTREFNO = B.OTREFNO
                                                AND C26.OTPAYSAV >= 0
                                        );
                                    ]]>
                                </beans:value>
                            </beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f07-del-neg" next="f07-a26-export">
                    <description>把 A26, B26, C26 金額欄位小於零的資料刪除掉</description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource" />
                            <beans:property name="sql" value="DELETE FROM A26 WHERE OTPAYSAV &lt;= 0; DELETE FROM C26 WHERE OTPAYSAV &lt;= 0; DELETE FROM C26 WHERE OTPAYSAV &lt;= 0;" />
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f07-a26-export" next="f07-b26-export">
                    <description>把 A26 的資料匯出至檔案</description>
                    <tasklet>
                        <chunk reader="a26DbReader" processor="a26Processor" writer="a26Writer" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f07-b26-export" next="f07-c26-export">
                    <description>把 B26 的資料匯出至檔案</description>
                    <tasklet>
                        <chunk reader="b26DbReader" processor="b26Processor" writer="b26Writer" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f07-c26-export" next="f99Decision">
                    <description>把 C26 的資料匯出至檔案</description>
                    <tasklet>
                        <chunk reader="c26DbReader" processor="c26Processor" writer="c26Writer" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <decision id="f99Decision" decider="f99Decider">
                    <next on="EXECUTE" to="f99-genReport" />
                    <end on="SKIP" />
                </decision>
                <step id="f99-genReport">
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.GenerateReportTasklet">
                            <beans:property name="resource">
                                <beans:bean class="org.springframework.core.io.FileSystemResource">
                                    <beans:constructor-arg value="#{systemProperties['FOLDER.PROCESS.OUT']}/report.xls"></beans:constructor-arg>
                                </beans:bean>
                            </beans:property>
                            <beans:property name="tableFlowDao" ref="tableFlowDao"></beans:property>
                            <beans:property name="reportDao" ref="reportDao"></beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
            <flow>
                <decision id="f18Decision" decider="f18Decider">
                    <next on="EXECUTE" to="f18-delete-table" />
                    <end on="SKIP" />
                </decision>
                <step id="f18-delete-table" next="f18-copy-currency">
                    <description></description>
                    <tasklet>
                        <beans:bean class="tw.com.citi.cdic.batch.step.tasklet.SqlCommandTasklet">
                            <beans:property name="dataSource" ref="dataSource"></beans:property>
                            <beans:property name="sql" value="DELETE FROM CDICF20"></beans:property>
                        </beans:bean>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f18-copy-currency" next="f18">
                    <description>Copy CDICF20 至 table</description>
                    <tasklet>
                        <chunk reader="cdicF20FileReader" writer="cdicF20DbWriter" commit-interval="500"></chunk>
                        <listeners>
                            <listener ref="stepListener" />
                        </listeners>
                    </tasklet>
                </step>
                <step id="f18">
                    <description>Summarise BUS view 的資料，產生 A61</description>
                    <tasklet task-executor="asyncTaskExecutor" throttle-limit="20">
                        <chunk reader="cifDbReader" processor="SBF18Processor" writer="f18Writer" commit-interval="200"></chunk>
                        <listeners>
                            <listener ref="lastStepListener" />
                        </listeners>
                    </tasklet>
                </step>
            </flow>
        </split>
        <listeners>
            <listener ref="lastStepListener" />
        </listeners>
    </job>

    <beans:bean id="lastStepListener" class="tw.com.citi.cdic.batch.FileStatusUpdater">
        <beans:property name="CDICFileStatusDao" ref="CDICFileStatusDao"></beans:property>
    </beans:bean>

    <beans:bean id="stepListener" class="tw.com.citi.cdic.batch.FileStatusUpdaterInProcess">
        <beans:property name="CDICFileStatusDao" ref="CDICFileStatusDao"></beans:property>
    </beans:bean>

    <beans:bean id="jobRegistry" class="org.springframework.batch.core.configuration.support.MapJobRegistry"></beans:bean>

    <beans:bean id="jobRegistryBeanPostProcessor" class="org.springframework.batch.core.configuration.support.JobRegistryBeanPostProcessor">
        <beans:property name="jobRegistry" ref="jobRegistry"></beans:property>
    </beans:bean>

    <beans:bean id="jobOperator" class="org.springframework.batch.core.launch.support.SimpleJobOperator">
        <beans:property name="jobExplorer">
            <beans:bean class="org.springframework.batch.core.explore.support.JobExplorerFactoryBean">
                <beans:property name="dataSource" ref="dataSource"></beans:property>
            </beans:bean>
        </beans:property>
        <beans:property name="jobRepository" ref="jobRepository"></beans:property>
        <beans:property name="jobRegistry" ref="jobRegistry"></beans:property>
        <beans:property name="jobLauncher" ref="jobLauncher"></beans:property>
    </beans:bean>

    <beans:bean class="org.springframework.remoting.rmi.RmiServiceExporter">
        <beans:property name="serviceName" value="BatchService"></beans:property>
        <beans:property name="service" ref="jobOperator"></beans:property>
        <beans:property name="serviceInterface" value="org.springframework.batch.core.launch.JobOperator"></beans:property>
        <beans:property name="registryPort" value="1099"></beans:property>
    </beans:bean>

</beans:beans>
